name: Publish Release

on:
  release:
    types: [published]

permissions:
  contents: write

env:
  JAVA_VERSION: "21"

jobs:
  # =============================================================================
  # Prepare build matrix from gradle.properties
  # Reads primary version + alt_versions to create a matrix of all MC versions
  # =============================================================================
  prepare-matrix:
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.set-matrix.outputs.matrix }}
      supported_versions: ${{ steps.set-matrix.outputs.supported_versions }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Build version matrix
        id: set-matrix
        run: |
          # Read primary version properties (use sed to trim spaces)
          # Use pattern with ' =' to avoid partial matches (e.g., yarn_mappings vs yarn_mappings_patch_neoforge_version)
          MC_VERSION=$(grep '^minecraft_version =' gradle.properties | cut -d'=' -f2 | sed 's/^[[:space:]]*//;s/[[:space:]]*$//')
          YARN=$(grep '^yarn_mappings =' gradle.properties | cut -d'=' -f2 | sed 's/^[[:space:]]*//;s/[[:space:]]*$//')
          FABRIC_LOADER=$(grep '^fabric_loader_version =' gradle.properties | cut -d'=' -f2 | sed 's/^[[:space:]]*//;s/[[:space:]]*$//')
          FABRIC_API=$(grep '^fabric_api_version =' gradle.properties | cut -d'=' -f2 | sed 's/^[[:space:]]*//;s/[[:space:]]*$//')
          NEOFORGE=$(grep '^neoforge_version =' gradle.properties | cut -d'=' -f2 | sed 's/^[[:space:]]*//;s/[[:space:]]*$//')
          SUPPORTED=$(grep '^supported_minecraft_versions =' gradle.properties | cut -d'=' -f2 | sed 's/^[[:space:]]*//;s/[[:space:]]*$//')
          
          # Build primary version object using jq for proper JSON escaping
          PRIMARY=$(jq -n -c \
            --arg mc "$MC_VERSION" \
            --arg yarn "$YARN" \
            --arg fl "$FABRIC_LOADER" \
            --arg fa "$FABRIC_API" \
            --arg neo "$NEOFORGE" \
            '{minecraft_version: $mc, yarn_mappings: $yarn, fabric_loader_version: $fl, fabric_api_version: $fa, neoforge_version: $neo}')
          
          echo "Primary: $PRIMARY"
          
          # Check for alt_versions (uncommented line) - use sed instead of xargs to preserve JSON
          ALT_LINE=$(grep '^alt_versions' gradle.properties | cut -d'=' -f2- | sed 's/^[[:space:]]*//;s/[[:space:]]*$//' || echo "")
          
          if [ -n "$ALT_LINE" ]; then
            echo "Alt versions: $ALT_LINE"
            # Parse alt_versions JSON array and merge with primary
            MATRIX=$(echo "$ALT_LINE" | jq -c --argjson primary "$PRIMARY" '{include: ([$primary] + .)}')
          else
            # Only primary version
            MATRIX=$(jq -n -c --argjson primary "$PRIMARY" '{include: [$primary]}')
          fi
          
          echo "Matrix: $MATRIX"
          echo "matrix=$MATRIX" >> $GITHUB_OUTPUT
          echo "supported_versions=$SUPPORTED" >> $GITHUB_OUTPUT

  # =============================================================================
  # Build for each Minecraft version in the matrix
  # =============================================================================
  build:
    needs: prepare-matrix
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix: ${{ fromJson(needs.prepare-matrix.outputs.matrix) }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Apply version overrides for MC ${{ matrix.minecraft_version }}
        run: |
          echo "Building for Minecraft ${{ matrix.minecraft_version }}"
          
          # Override gradle.properties with matrix values
          sed -i "s/^minecraft_version = .*/minecraft_version = ${{ matrix.minecraft_version }}/" gradle.properties
          sed -i "s/^yarn_mappings = .*/yarn_mappings = ${{ matrix.yarn_mappings }}/" gradle.properties
          sed -i "s/^fabric_loader_version = .*/fabric_loader_version = ${{ matrix.fabric_loader_version }}/" gradle.properties
          sed -i "s/^fabric_api_version = .*/fabric_api_version = ${{ matrix.fabric_api_version }}/" gradle.properties
          sed -i "s/^neoforge_version = .*/neoforge_version = ${{ matrix.neoforge_version }}/" gradle.properties
          
          echo "=== Updated gradle.properties ==="
          grep -E '^(minecraft_version|yarn_mappings|fabric_loader_version|fabric_api_version|neoforge_version)' gradle.properties

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: ${{ env.JAVA_VERSION }}

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v4

      - name: Build
        run: |
          chmod +x ./gradlew
          ./gradlew clean build --no-daemon

      - name: Upload Fabric JAR
        uses: actions/upload-artifact@v4
        with:
          name: fabric-jar-${{ matrix.minecraft_version }}
          path: |
            fabric/build/libs/vouch-fabric-*.jar
            !fabric/build/libs/*-dev-shadow.jar
            !fabric/build/libs/*-sources.jar
          if-no-files-found: error

      - name: Upload NeoForge JAR
        uses: actions/upload-artifact@v4
        with:
          name: neoforge-jar-${{ matrix.minecraft_version }}
          path: |
            neoforge/build/libs/vouch-neoforge-*.jar
            !neoforge/build/libs/*-dev-shadow.jar
            !neoforge/build/libs/*-sources.jar
          if-no-files-found: error

  # =============================================================================
  # Publish Fabric builds to Modrinth & CurseForge
  # =============================================================================
  publish-fabric:
    needs: [prepare-matrix, build]
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix: ${{ fromJson(needs.prepare-matrix.outputs.matrix) }}
    steps:
      - name: Download Fabric JAR for MC ${{ matrix.minecraft_version }}
        uses: actions/download-artifact@v4
        with:
          name: fabric-jar-${{ matrix.minecraft_version }}
          path: fabric-artifacts

      - name: Determine version type
        id: version_type
        run: |
          TAG="${{ github.event.release.tag_name }}"
          if [[ "$TAG" == *"-alpha"* ]]; then
            echo "type=alpha" >> $GITHUB_OUTPUT
          elif [[ "$TAG" == *"-beta"* ]] || [[ "${{ github.event.release.prerelease }}" == "true" ]]; then
            echo "type=beta" >> $GITHUB_OUTPUT
          else
            echo "type=release" >> $GITHUB_OUTPUT
          fi

      - name: Publish Fabric to Modrinth & CurseForge (MC ${{ matrix.minecraft_version }})
        uses: Kir-Antipov/mc-publish@v3.3
        with:
          modrinth-id: ${{ vars.MODRINTH_PROJECT_ID }}
          modrinth-token: ${{ secrets.MODRINTH_TOKEN }}

          curseforge-id: ${{ vars.CURSEFORGE_PROJECT_ID }}
          curseforge-token: ${{ secrets.CURSEFORGE_TOKEN }}

          files: fabric-artifacts/vouch-fabric-*.jar
          name: "Vouch ${{ github.event.release.tag_name }} (Fabric ${{ matrix.minecraft_version }})"
          version: "${{ github.event.release.tag_name }}+mc${{ matrix.minecraft_version }}-fabric"
          version-type: ${{ steps.version_type.outputs.type }}
          changelog: ${{ github.event.release.body }}
          game-versions: ${{ matrix.minecraft_version }}
          loaders: fabric
          dependencies: |
            fabric-api | depends
            architectury-api | depends

  # =============================================================================
  # Publish NeoForge builds to Modrinth & CurseForge
  # =============================================================================
  publish-neoforge:
    needs: [prepare-matrix, build]
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix: ${{ fromJson(needs.prepare-matrix.outputs.matrix) }}
    steps:
      - name: Download NeoForge JAR for MC ${{ matrix.minecraft_version }}
        uses: actions/download-artifact@v4
        with:
          name: neoforge-jar-${{ matrix.minecraft_version }}
          path: neoforge-artifacts

      - name: Determine version type
        id: version_type
        run: |
          TAG="${{ github.event.release.tag_name }}"
          if [[ "$TAG" == *"-alpha"* ]]; then
            echo "type=alpha" >> $GITHUB_OUTPUT
          elif [[ "$TAG" == *"-beta"* ]] || [[ "${{ github.event.release.prerelease }}" == "true" ]]; then
            echo "type=beta" >> $GITHUB_OUTPUT
          else
            echo "type=release" >> $GITHUB_OUTPUT
          fi

      - name: Publish NeoForge to Modrinth & CurseForge (MC ${{ matrix.minecraft_version }})
        uses: Kir-Antipov/mc-publish@v3.3
        with:
          modrinth-id: ${{ vars.MODRINTH_PROJECT_ID }}
          modrinth-token: ${{ secrets.MODRINTH_TOKEN }}

          curseforge-id: ${{ vars.CURSEFORGE_PROJECT_ID }}
          curseforge-token: ${{ secrets.CURSEFORGE_TOKEN }}

          files: neoforge-artifacts/vouch-neoforge-*.jar
          name: "Vouch ${{ github.event.release.tag_name }} (NeoForge ${{ matrix.minecraft_version }})"
          version: "${{ github.event.release.tag_name }}+mc${{ matrix.minecraft_version }}-neoforge"
          version-type: ${{ steps.version_type.outputs.type }}
          changelog: ${{ github.event.release.body }}
          game-versions: ${{ matrix.minecraft_version }}
          loaders: neoforge
          dependencies: |
            architectury-api | depends

  # =============================================================================
  # Attach all built JARs to the GitHub Release
  # =============================================================================
  attach-jars:
    needs: [prepare-matrix, build]
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts
          pattern: "*-jar-*"

      - name: List artifacts
        run: find artifacts -name "*.jar" -type f

      - name: Attach JARs to GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          files: |
            artifacts/**/vouch-*.jar
